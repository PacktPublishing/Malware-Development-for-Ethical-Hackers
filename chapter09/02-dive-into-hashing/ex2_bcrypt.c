#include <windows.h>
#include <bcrypt.h>
#include <stdio.h>

#pragma comment(lib, "bcrypt.lib")

int main() {
  BCRYPT_ALG_HANDLE hAlgorithm;
  BCRYPT_HASH_HANDLE hHash;
  NTSTATUS status;

  // Open an algorithm provider
  if ((status = BCryptOpenAlgorithmProvider(&hAlgorithm, BCRYPT_SHA256_ALGORITHM, NULL, 0)) != STATUS_SUCCESS) {
    fprintf(stderr, "BCryptOpenAlgorithmProvider failed: %x\n", status);
    exit(1);
  }

  // Create a hash
  if ((status = BCryptCreateHash(hAlgorithm, &hHash, NULL, 0, NULL, 0, 0)) != STATUS_SUCCESS) {
    fprintf(stderr, "BCryptCreateHash failed: %x\n", status);
    exit(1);
  }

  // Hash some data (e.g., a password)
  const char* password = "mysupersecretpassword";
  if ((status = BCryptHashData(hHash, (PBYTE)password, (ULONG)strlen(password), 0)) != STATUS_SUCCESS) {
    fprintf("BCryptHashData failed: %x\n", status);
    exit(1);
  }

  // Finalize the hash
  DWORD hashSize;
  if ((status = BCryptGetProperty(hAlgorithm, BCRYPT_HASH_LENGTH, (PBYTE)&hashSize, sizeof(DWORD), NULL, 0)) != STATUS_SUCCESS)
    printf("BCryptGetProperty failed\n");

  PBYTE hashBuffer = (PBYTE)malloc(hashSize);
  if (!hashBuffer)
    printf("Memory allocation failed\n");

  if ((status = BCryptFinishHash(hHash, hashBuffer, hashSize, 0)) != STATUS_SUCCESS)
    printf("BCryptFinishHash failed\n");

  // Print the hash
  printf("Hash: ");
  for (DWORD i = 0; i < hashSize; i++)
    printf("%02x", hashBuffer[i]);
  printf("\n");

  // Cleanup
  free(hashBuffer);
  BCryptDestroyHash(hHash);
  BCryptCloseAlgorithmProvider(hAlgorithm, 0);

  return 0;
}
