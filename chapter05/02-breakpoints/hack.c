/*
 * Malware Development for Ethical Hackers
 * hack.c - Anti-debugging tricks
 * check for breakpoints
 * author: @cocomelonc
*/
#include <windows.h>
#include <stdio.h>
#include <psapi.h>

int main() {
  BOOL isDebuggerPresent = FALSE;

  PSAPI_WORKING_SET_INFORMATION* workingSetInfo;
  DWORD bufferCapacity = sizeof(PSAPI_WORKING_SET_INFORMATION) * 1024; // Adjust the size as necessary
  workingSetInfo = (PSAPI_WORKING_SET_INFORMATION*)VirtualAlloc(0, bufferCapacity, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);

  if (workingSetInfo == NULL) {
    printf("Failed to allocate memory for working set information.\n");
    return 1;
  }

  if (!QueryWorkingSet(GetCurrentProcess(), workingSetInfo, bufferCapacity)) {
    printf("QueryWorkingSet failed with error %lu.\n", GetLastError());
    VirtualFree(workingSetInfo, 0, MEM_RELEASE);
    return 1;
  }

  for (DWORD pageIndex = 0; pageIndex < workingSetInfo->NumberOfEntries; pageIndex++) {
    PVOID pageAddress = (PVOID)(workingSetInfo->WorkingSetInfo[pageIndex].VirtualPage * 4096);
    MEMORY_BASIC_INFORMATION pageInfo;
    if (VirtualQuery(pageAddress, &pageInfo, sizeof(pageInfo)) == 0) {
      printf("VirtualQuery failed with error %lu.\n", GetLastError());
      break;
    }

    if (pageInfo.Protect & (PAGE_EXECUTE | PAGE_EXECUTE_READ | PAGE_EXECUTE_READWRITE | PAGE_EXECUTE_WRITECOPY)) {
      if (workingSetInfo->WorkingSetInfo[pageIndex].Shared == 0 || workingSetInfo->WorkingSetInfo[pageIndex].ShareCount == 0) {
        isDebuggerPresent = TRUE;
        break;
      }
    }
  }

  VirtualFree(workingSetInfo, 0, MEM_RELEASE);

  if (isDebuggerPresent) {
    printf("Debugger detected.\n");
    return 1;
  }

  MessageBox(NULL, "Meow!", "=^..^=", MB_OK);
c
  return 0;
}